#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ BACKEND_URL

echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ BACKEND_URL"
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
    touch .env
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ BACKEND_URL
if grep -q "^BACKEND_URL=" .env; then
    echo "‚ö†Ô∏è BACKEND_URL —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env"
    echo
    echo "–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:"
    grep "^BACKEND_URL=" .env
    echo
    read -p "–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚úÖ –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
        exit 0
    fi
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    sed -i.bak '/^BACKEND_URL=/d' .env
fi

echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
echo "1) –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (http://localhost:8000)"
echo "2) Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (http://admin:8000)"
echo "3) –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä (https://your-domain.com)"
echo "4) –í–≤–µ—Å—Ç–∏ —Å–≤–æ–π URL"
echo

read -p "–í–∞—à –≤—ã–±–æ—Ä (1-4): " -n 1 -r choice
echo

case $choice in
    1)
        BACKEND_URL="http://localhost:8000"
        echo "üè† –í—ã–±—Ä–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞: $BACKEND_URL"
        ;;
    2)
        BACKEND_URL="http://admin:8000"
        echo "üê≥ –í—ã–±—Ä–∞–Ω Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $BACKEND_URL"
        ;;
    3)
        echo "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω (–±–µ–∑ http/https):"
        read -r domain
        
        if [ -z "$domain" ]; then
            echo "‚ùå –î–æ–º–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
            exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å http
        if [[ $domain == http* ]]; then
            BACKEND_URL="$domain"
        else
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª
            echo "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª:"
            echo "1) HTTPS (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)"
            echo "2) HTTP"
            read -p "–ü—Ä–æ—Ç–æ–∫–æ–ª (1-2): " -n 1 -r protocol
            echo
            
            case $protocol in
                1)
                    BACKEND_URL="https://$domain"
                    ;;
                2)
                    BACKEND_URL="http://$domain"
                    ;;
                *)
                    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º HTTPS"
                    BACKEND_URL="https://$domain"
                    ;;
            esac
        fi
        
        echo "üåç –í—ã–±—Ä–∞–Ω –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä: $BACKEND_URL"
        ;;
    4)
        echo "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL (—Å http:// –∏–ª–∏ https://):"
        read -r custom_url
        
        if [ -z "$custom_url" ]; then
            echo "‚ùå URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
            exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç URL
        if [[ ! $custom_url =~ ^https?:// ]]; then
            echo "‚ùå URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://"
            exit 1
        fi
        
        BACKEND_URL="$custom_url"
        echo "üîó –í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π URL: $BACKEND_URL"
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

# –î–æ–±–∞–≤–ª—è–µ–º –≤ .env
echo "BACKEND_URL=$BACKEND_URL" >> .env

echo
echo "‚úÖ BACKEND_URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo
echo "üí° –≠—Ç–æ—Ç URL –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –¥–ª—è:"
echo "   ‚Ä¢ –ü—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Telegram (/api/telegram/link)"
echo "   ‚Ä¢ –î—Ä—É–≥–∏—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–∞—à–µ–º—É –±—ç–∫–µ–Ω–¥—É"
echo
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ .env —Ñ–∞–π–ª–µ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π .env (—Ç–æ–ª—å–∫–æ BACKEND_URL)
echo
echo "üìÑ –¢–µ–∫—É—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:"
grep "^BACKEND_URL=" .env

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞
case $choice in
    1)
        echo
        echo "üí° –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:"
        echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∞–¥–º–∏–Ω–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8000"
        echo "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./start.sh"
        ;;
    2)
        echo
        echo "üí° –î–ª—è Docker:"
        echo "   ‚Ä¢ –≠—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π URL –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏"
        echo "   ‚Ä¢ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 'admin' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω"
        echo "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./start.sh"
        ;;
    3|4)
        echo
        echo "üí° –î–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:"
        echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —ç—Ç–æ–º—É URL"
        echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"
        echo "   ‚Ä¢ –î–ª—è HTTPS —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        ;;
esac
