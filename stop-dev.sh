#!/bin/bash

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–æ–π —Å—Ä–µ–¥—ã"
echo "================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
stop_process() {
    local process_name="$1"
    local display_name="$2"
    
    # –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å Python —Å –Ω—É–∂–Ω—ã–º —Ñ–∞–π–ª–æ–º
    local pids=$(pgrep -f "python.*$process_name")
    
    if [ -n "$pids" ]; then
        echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $display_name..."
        for pid in $pids; do
            kill $pid 2>/dev/null
            echo "  ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $pid –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        done
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        sleep 2
        
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
        local remaining=$(pgrep -f "python.*$process_name")
        if [ -n "$remaining" ]; then
            echo "  ‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
            for pid in $remaining; do
                kill -9 $pid 2>/dev/null
            done
        fi
    else
        echo "‚ÑπÔ∏è $display_name –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
}

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–¥–º–∏–Ω–∫—É
stop_process "admin.py" "–ê–¥–º–∏–Ω–∫–∞"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
stop_process "bot.py" "–ë–æ—Ç"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã..."

admin_running=$(pgrep -f "python.*admin.py" | wc -l)
bot_running=$(pgrep -f "python.*bot.py" | wc -l)

if [ "$admin_running" -eq 0 ] && [ "$bot_running" -eq 0 ]; then
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –µ—â–µ –∑–∞–ø—É—â–µ–Ω—ã:"
    if [ "$admin_running" -gt 0 ]; then
        echo "  - –ê–¥–º–∏–Ω–∫–∞: $admin_running –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    fi
    if [ "$bot_running" -gt 0 ]; then
        echo "  - –ë–æ—Ç: $bot_running –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    fi
    
    echo ""
    echo "üîß –î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö Python –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
    echo "   pkill -f python"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Ä—Ç–æ–≤
echo ""
echo "üåê –°—Ç–∞—Ç—É—Å –ø–æ—Ä—Ç–æ–≤:"
if command -v lsof &> /dev/null; then
    port_8000=$(lsof -ti:8000 | wc -l)
    if [ "$port_8000" -gt 0 ]; then
        echo "  ‚ö†Ô∏è –ü–æ—Ä—Ç 8000 –∑–∞–Ω—è—Ç (–≤–æ–∑–º–æ–∂–Ω–æ –∞–¥–º–∏–Ω–∫–∞ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)"
        echo "     –ü—Ä–æ—Ü–µ—Å—Å—ã: $(lsof -ti:8000 | tr '\n' ' ')"
    else
        echo "  ‚úÖ –ü–æ—Ä—Ç 8000 —Å–≤–æ–±–æ–¥–µ–Ω"
    fi
else
    echo "  ‚ÑπÔ∏è lsof –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã"
fi

echo ""
echo "üìÅ –§–∞–π–ª—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:"
if [ -f "dev_bot_data.db" ]; then
    db_size=$(du -h dev_bot_data.db | cut -f1)
    echo "  üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: dev_bot_data.db ($db_size)"
else
    echo "  ‚ÑπÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

if [ -f ".env.dev" ]; then
    echo "  ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: .env.dev"
else
    echo "  ‚ÑπÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

if [ -d "venv" ]; then
    echo "  üêç –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: venv/"
else
    echo "  ‚ÑπÔ∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  ‚Ä¢ –ó–∞–ø—É—Å–∫: ./start-dev.sh"
echo "  ‚Ä¢ –û—á–∏—Å—Ç–∫–∞ –ë–î: rm dev_bot_data.db"
echo "  ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f *.log"
echo "  ‚Ä¢ –¢–µ—Å—Ç—ã: python3 test_simple.py"

echo ""
echo "‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–∞—è —Å—Ä–µ–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
