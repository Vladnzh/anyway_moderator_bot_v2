# üîó –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Telegram

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–≤—è–∑—ã–≤–∞—Ç—å Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –≤ –≤–∞—à–µ–π –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã.

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–í–∞—à –±—ç–∫–µ–Ω–¥** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ –±–æ—Ç—É —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/start <–ö–û–î>` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
3. **–ë–æ—Ç** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ HMAC –ø–æ–¥–ø–∏—Å—å—é
4. **–í–∞—à –±—ç–∫–µ–Ω–¥** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç—ã

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á

```bash
./setup-shared-secret.sh
```

–≠—Ç–æ—Ç –∫–ª—é—á –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HMAC-SHA256 –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ URL –±—ç–∫–µ–Ω–¥–∞

```bash
./setup-backend-url.sh
```

–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:
- **–õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞** - `http://localhost:8000`
- **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** - `http://admin:8000`
- **–í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä** - `https://your-domain.com`

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ `.env` —Ñ–∞–π–ª–µ:

```env
BOT_SHARED_SECRET=your_secret_key_here
BACKEND_URL=https://your-backend.com  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é http://localhost:8000
```

> üí° **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üì° API Endpoint

–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à endpoint:

```
POST /api/telegram/link
```

### –ó–∞–≥–æ–ª–æ–≤–∫–∏

```
Content-Type: application/json
X-Signature: hmac_sha256_signature
```

### –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞

```json
{
  "code": "user_link_code",
  "tg_user_id": "123456789",
  "username": "john_doe",
  "first_name": "John",
  "last_name": "Doe"
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏

```python
import hmac
import hashlib
import json

def verify_signature(body: str, signature: str, secret: str) -> bool:
    expected = hmac.new(
        secret.encode('utf-8'),
        body.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected)

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
request_body = json.dumps(request_data, separators=(',', ':'), ensure_ascii=False)
is_valid = verify_signature(request_body, signature, BOT_SHARED_SECRET)
```

## üìã –û—Ç–≤–µ—Ç—ã –±—ç–∫–µ–Ω–¥–∞

### ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ (200)

```json
{
  "status": "linked"
}
```

**–û—Ç–≤–µ—Ç –±–æ—Ç–∞:** "‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω"

### ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –∫–æ–¥ (400)

```json
{
  "error": "invalid_or_expired_code"
}
```

**–û—Ç–≤–µ—Ç –±–æ—Ç–∞:** "‚ùå –ö–æ–¥ –Ω–µ–≤—ñ—Ä–Ω–∏–π –∞–±–æ —Å—Ç—Ä–æ–∫ –¥—ñ—ó –º–∏–Ω—É–≤"

### ‚ö†Ô∏è Telegram —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω (409)

```json
{
  "error": "tg_already_linked_to_another_user"
}
```

**–û—Ç–≤–µ—Ç –±–æ—Ç–∞:** "‚ö†Ô∏è –¶–µ–π Telegram –≤–∂–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π –¥–æ —ñ–Ω—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞"

### üö´ –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏

**–û—Ç–≤–µ—Ç –±–æ—Ç–∞:** "üö´ –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑"

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ö–æ–º–∞–Ω–¥–∞ /start —Å –∫–æ–¥–æ–º

```
/start ABC123DEF456
```

### –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º

```
ABC123DEF456
```

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–¥—ã –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
- –î–ª–∏–Ω–∞ –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
- –û–¥–∏–Ω —Ç–æ–∫–µ–Ω –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
- –°–æ–¥–µ—Ä–∂–∏—Ç —Ü–∏—Ñ—Ä—ã –∏–ª–∏ —Å–∏–º–≤–æ–ª—ã `-`, `_`
- –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–µ—à—Ç–µ–≥–∏
- –ù–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è HMAC-SHA256
- –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —É –±–æ—Ç–∞ –∏ –±—ç–∫–µ–Ω–¥–∞
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –¥–ª—è –±—ç–∫–µ–Ω–¥–∞
- –ö–æ–¥—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏
- –ö–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º–∏

## üõ†Ô∏è –ü—Ä–∏–º–µ—Ä –±—ç–∫–µ–Ω–¥–∞ (FastAPI)

```python
from fastapi import FastAPI, HTTPException, Header
import hmac
import hashlib
import json

app = FastAPI()

BOT_SHARED_SECRET = "your_secret_key"

def verify_signature(body: str, signature: str) -> bool:
    expected = hmac.new(
        BOT_SHARED_SECRET.encode('utf-8'),
        body.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected)

@app.post("/api/telegram/link")
async def link_telegram(
    data: dict,
    x_signature: str = Header(alias="X-Signature")
):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
    body = json.dumps(data, separators=(',', ':'), ensure_ascii=False)
    if not verify_signature(body, x_signature):
        raise HTTPException(status_code=401, detail="Invalid signature")
    
    code = data.get("code")
    tg_user_id = data.get("tg_user_id")
    
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
    if not is_valid_code(code):
        raise HTTPException(
            status_code=400, 
            detail={"error": "invalid_or_expired_code"}
        )
    
    if is_telegram_already_linked(tg_user_id):
        raise HTTPException(
            status_code=409,
            detail={"error": "tg_already_linked_to_another_user"}
        )
    
    # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç
    link_account(code, tg_user_id, data)
    
    return {"status": "linked"}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —Å –≥–æ—Ç–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   python test_link_server.py
   ```

2. **–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–¥:**
   –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/generate-code

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   ```bash
   # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã
   ./setup-shared-secret.sh  # –í—ã–±–µ—Ä–∏—Ç–µ "2" –∏ –≤–≤–µ–¥–∏—Ç–µ: test_secret_key_123456789
   ./setup-backend-url.sh    # –í—ã–±–µ—Ä–∏—Ç–µ "4" –∏ –≤–≤–µ–¥–∏—Ç–µ: http://localhost:3000
   
   # –ò–ª–∏ –≤—Ä—É—á–Ω—É—é –≤ .env —Ñ–∞–π–ª–µ
   BOT_SHARED_SECRET=test_secret_key_123456789
   BACKEND_URL=http://localhost:3000
   ```

4. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É:**
   `/start <–°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô_–ö–û–î>`

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å "‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω"
   - –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤—è–∑–∫–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –±—ç–∫–µ–Ω–¥
2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É: `/start TEST123`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ –∏ –±—ç–∫–µ–Ω–¥–∞

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ë–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏:

```
üîó –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: user_id=123456789, code=ABC123DE...
‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω: user_id=123456789
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: invalid_or_expired_code
```
