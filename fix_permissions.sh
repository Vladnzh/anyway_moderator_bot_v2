#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "====================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

echo ""
echo "üõë 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down

echo ""
echo "üìÅ 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É data –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p data
echo "‚úÖ –ü–∞–ø–∫–∞ data —Å–æ–∑–¥–∞–Ω–∞"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
chmod 755 data
echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –ø–∞–ø–∫—É data: 755"

# –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f "data/bot_data.db" ]; then
    touch data/bot_data.db
    echo "‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
fi

chmod 644 data/bot_data.db
echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: 644"

# –°–æ–∑–¥–∞—ë–º .gitkeep –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f "data/.gitkeep" ]; then
    touch data/.gitkeep
    echo "‚úÖ –°–æ–∑–¥–∞–Ω .gitkeep —Ñ–∞–π–ª"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ (UID 1000 –∏–∑ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
if chown -R 1000:1000 data/ 2>/dev/null; then
    echo "‚úÖ –í–ª–∞–¥–µ–ª–µ—Ü —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 1000:1000"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ root)"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chown -R 1000:1000 data/"
    
    # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ sudo
    if command -v sudo >/dev/null 2>&1; then
        echo "üîß –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ sudo..."
        if sudo chown -R 1000:1000 data/ 2>/dev/null; then
            echo "‚úÖ –í–ª–∞–¥–µ–ª–µ—Ü —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ sudo"
        else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞"
        fi
    fi
fi

echo ""
echo "üìã 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."
ls -la data/

echo ""
echo "üöÄ 4. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose up -d

echo ""
echo "‚è≥ 5. –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

echo ""
echo "üìä 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
docker compose ps

echo ""
echo "üìã 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
docker compose logs --tail=5 bot

echo ""
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üí° –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: ls -la data/"
echo "   2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞: sudo chown -R 1000:1000 data/"
echo "   3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: docker compose restart"
