#!/bin/bash

echo "üõ†Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
echo "=================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "bot.py" ] || [ ! -f "admin.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: bot.py –∏–ª–∏ admin.py –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.6+"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º .env.dev —Ñ–∞–π–ª
if [ ! -f ".env.dev" ]; then
    echo "üìù –°–æ–∑–¥–∞–µ–º .env.dev —Ñ–∞–π–ª –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–æ–≥–æ –±–æ—Ç–∞
    echo ""
    echo "ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–æ–≥–æ –±–æ—Ç–∞"
    echo "–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞"
    echo ""
    
    while true; do
        read -p "–í–≤–µ–¥–∏—Ç–µ DEV_BOT_TOKEN: " DEV_BOT_TOKEN
        if [[ "$DEV_BOT_TOKEN" =~ ^[0-9]+:[A-Za-z0-9_-]+$ ]]; then
            break
        else
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞. –§–æ—Ä–º–∞—Ç: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
        fi
    done
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    DEV_ADMIN_TOKEN=$(openssl rand -hex 16 2>/dev/null || python3 -c "import secrets; print(secrets.token_hex(16))" 2>/dev/null || head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)
    
    # –°–æ–∑–¥–∞–µ–º .env.dev
    cat > .env.dev << EOF
# –¢–æ–∫–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–æ–≥–æ –±–æ—Ç–∞ –æ—Ç @BotFather
BOT_TOKEN=$DEV_BOT_TOKEN

# –¢–æ–∫–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
ADMIN_TOKEN=$DEV_ADMIN_TOKEN

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
DATABASE_PATH=dev_bot_data.db

# URL –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–µ)
ADMIN_URL=http://localhost:8000
FRONTEND_URL=http://localhost:3000

# Shared secret –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# BOT_SHARED_SECRET=dev_secret_key_for_testing

# –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
DEV_MODE=true
EOF
    
    echo "‚úÖ –°–æ–∑–¥–∞–Ω .env.dev —Ñ–∞–π–ª"
    echo "üîë DEV_ADMIN_TOKEN: $DEV_ADMIN_TOKEN"
else
    echo "üìÑ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .env.dev —Ñ–∞–π–ª"
    source .env.dev
    if [ -n "$ADMIN_TOKEN" ]; then
        echo "üîë DEV_ADMIN_TOKEN: ${ADMIN_TOKEN:0:8}...${ADMIN_TOKEN: -4}"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
echo ""
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python..."

if [ ! -f "requirements.txt" ]; then
    echo "‚ùå requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ ! -d "venv" ]; then
    echo "üêç –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv
    
    if [ $? -ne 0 ]; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
        echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ python3-venv: sudo apt install python3-venv"
        exit 1
    fi
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üîÑ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source venv/bin/activate

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install -r requirements.txt

if [ $? -ne 0 ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    exit 1
fi

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
echo ""
echo "üóÑÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.dev
export $(grep -v '^#' .env.dev | xargs)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
python3 -c "
import sys
sys.path.insert(0, '.')
from database import db
print('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞:', db.db_path)
"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
    
    if [ ! -z "$ADMIN_PID" ]; then
        kill $ADMIN_PID 2>/dev/null
        echo "‚úÖ –ê–¥–º–∏–Ω–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    fi
    
    if [ ! -z "$BOT_PID" ]; then
        kill $BOT_PID 2>/dev/null
        echo "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
    
    echo "üëã –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGINT SIGTERM

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."

# –ó–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–∫—É –≤ —Ñ–æ–Ω–µ
echo "üåê –ó–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–∫—É –Ω–∞ http://localhost:8000..."
python3 admin.py &
ADMIN_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∞–¥–º–∏–Ω–∫–∏
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞–¥–º–∏–Ω–∫–∞ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å
if ! curl -s http://localhost:8000 > /dev/null; then
    echo "‚ùå –ê–¥–º–∏–Ω–∫–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å!"
    kill $ADMIN_PID 2>/dev/null
    exit 1
fi

echo "‚úÖ –ê–¥–º–∏–Ω–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ (PID: $ADMIN_PID)"

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
python3 bot.py &
BOT_PID=$!

echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)"

echo ""
echo "üéâ –†–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–∞—è —Å—Ä–µ–¥–∞ –∑–∞–ø—É—â–µ–Ω–∞!"
echo "================================"
echo "üåê –ê–¥–º–∏–Ω–∫–∞: http://localhost:8000"
echo "üîë –¢–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∫–∏: $ADMIN_TOKEN"
echo "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DATABASE_PATH"
echo "ü§ñ –ë–æ—Ç: –∑–∞–ø—É—â–µ–Ω —Å —Ç–æ–∫–µ–Ω–æ–º ${BOT_TOKEN:0:10}...${BOT_TOKEN: -4}"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  ‚Ä¢ –¢–µ—Å—Ç—ã: python3 test_simple.py"
echo "  ‚Ä¢ –õ–æ–≥–∏ –±–æ—Ç–∞: tail -f bot.log (–µ—Å–ª–∏ –µ—Å—Ç—å)"
echo "  ‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∫–∞: Ctrl+C"
echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)"

# –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
wait
