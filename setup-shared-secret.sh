#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ BOT_SHARED_SECRET

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ BOT_SHARED_SECRET"
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
    touch .env
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ BOT_SHARED_SECRET
if grep -q "^BOT_SHARED_SECRET=" .env; then
    echo "‚ö†Ô∏è BOT_SHARED_SECRET —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env"
    echo
    echo "–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:"
    grep "^BOT_SHARED_SECRET=" .env | sed 's/BOT_SHARED_SECRET=\(.\{8\}\).*/BOT_SHARED_SECRET=\1.../'
    echo
    read -p "–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚úÖ –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
        exit 0
    fi
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    sed -i.bak '/^BOT_SHARED_SECRET=/d' .env
fi

echo "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
echo "1) –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
echo "2) –í–≤–µ—Å—Ç–∏ —Å–≤–æ–π —Å–µ–∫—Ä–µ—Ç"
echo

read -p "–í–∞—à –≤—ã–±–æ—Ä (1-2): " -n 1 -r choice
echo

case $choice in
    1)
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
        SECRET=$(openssl rand -hex 32 2>/dev/null || python3 -c "import secrets; print(secrets.token_hex(32))" 2>/dev/null || head /dev/urandom | tr -dc A-Za-z0-9 | head -c 64)
        
        if [ -z "$SECRET" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç"
            echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ openssl –∏–ª–∏ python3"
            exit 1
        fi
        
        echo "üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç: ${SECRET:0:8}..."
        ;;
    2)
        echo "–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç (–º–∏–Ω–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤):"
        read -s SECRET
        echo
        
        if [ ${#SECRET} -lt 16 ]; then
            echo "‚ùå –°–µ–∫—Ä–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤)"
            exit 1
        fi
        
        echo "‚úÖ –°–µ–∫—Ä–µ—Ç –ø—Ä–∏–Ω—è—Ç: ${SECRET:0:8}..."
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

# –î–æ–±–∞–≤–ª—è–µ–º –≤ .env
echo "BOT_SHARED_SECRET=$SECRET" >> .env

echo
echo "‚úÖ BOT_SHARED_SECRET –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo
echo "üí° –≠—Ç–æ—Ç —Å–µ–∫—Ä–µ—Ç –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –≤–∞—à–µ–º –±—ç–∫–µ–Ω–¥–µ"
echo "   –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ HMAC –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –±–æ—Ç–∞."
echo
echo "üîí –°–µ–∫—Ä–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ .env —Ñ–∞–π–ª–µ"
